name: Fix The Hostname

on:
  workflow_dispatch:

jobs:
  fix-hostname:
    name: Check and Set EC2 Hostname
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/ec2_key
          chmod 600 ~/.ssh/ec2_key
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts
      
      - name: Check Current Hostname
        id: check-hostname
        run: |
          echo "Checking current hostname..."
          CURRENT_HOSTNAME=$(ssh -i ~/.ssh/ec2_key ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "hostname")
          echo "Current hostname: $CURRENT_HOSTNAME"
          echo "current_hostname=$CURRENT_HOSTNAME" >> $GITHUB_OUTPUT
          
          if [ "$CURRENT_HOSTNAME" = "HelloWorld" ]; then
            echo "Hostname is already set to HelloWorld"
            echo "needs_change=false" >> $GITHUB_OUTPUT
          else
            echo "Hostname needs to be changed to HelloWorld"
            echo "needs_change=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Set Hostname to HelloWorld
        if: steps.check-hostname.outputs.needs_change == 'true'
        run: |
          echo "Setting hostname to HelloWorld..."
          ssh -i ~/.ssh/ec2_key ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            # Set hostname temporarily (immediate effect)
            sudo hostnamectl set-hostname HelloWorld
            
            # Update /etc/hostname for persistence across reboots
            echo "HelloWorld" | sudo tee /etc/hostname > /dev/null
            
            # Update /etc/hosts to reflect new hostname
            sudo sed -i 's/127.0.1.1.*/127.0.1.1\tHelloWorld/g' /etc/hosts
            
            echo "=================================================="
            echo "Hostname has been set to HelloWorld"
            echo "New hostname: $(hostname)"
            echo "=================================================="
          EOF
      
      - name: Verify Hostname Change
        if: steps.check-hostname.outputs.needs_change == 'true'
        run: |
          echo "Verifying hostname change..."
          NEW_HOSTNAME=$(ssh -i ~/.ssh/ec2_key ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "hostname")
          echo "Verified hostname: $NEW_HOSTNAME"
          
          if [ "$NEW_HOSTNAME" = "HelloWorld" ]; then
            echo "SUCCESS: Hostname successfully changed to HelloWorld"
          else
            echo "ERROR: Hostname change failed"
            exit 1
          fi
      
      - name: Hostname Already Correct
        if: steps.check-hostname.outputs.needs_change == 'false'
        run: |
          echo "=================================================="
          echo "No changes needed."
          echo "Hostname is already set to: HelloWorld"
          echo "=================================================="
      
      - name: Cleanup SSH Key
        if: always()
        run: |
          rm -f ~/.ssh/ec2_key
